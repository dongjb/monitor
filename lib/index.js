!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("store"),require("uuid")):"function"==typeof define&&define.amd?define(["store","uuid"],e):(t="undefined"!=typeof globalThis?globalThis:t||self).monitor=e(t.store,t.uuid)}(this,function(t,e){"use strict";function n(t){return t&&"object"==typeof t&&"default"in t?t:{default:t}}var d=n(t),i=function(){return(i=Object.assign||function(t){for(var e,n=1,i=arguments.length;n<i;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(t[o]=e[o]);return t}).apply(this,arguments)};function o(t,r,u,d){return new(u=u||Promise)(function(n,e){function i(t){try{a(d.next(t))}catch(t){e(t)}}function o(t){try{a(d.throw(t))}catch(t){e(t)}}function a(t){var e;t.done?n(t.value):((e=t.value)instanceof u?e:new u(function(t){t(e)})).then(i,o)}a((d=d.apply(t,r||[])).next())})}function s(n,i){var o,a,r,u={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},t={next:e(0),throw:e(1),return:e(2)};return"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function(e){if(o)throw new TypeError("Generator is already executing.");for(;u;)try{if(o=1,a&&(r=2&e[0]?a.return:e[0]?a.throw||((r=a.return)&&r.call(a),0):a.next)&&!(r=r.call(a,e[1])).done)return r;switch(a=0,(e=r?[2&e[0],r.value]:e)[0]){case 0:case 1:r=e;break;case 4:return u.label++,{value:e[1],done:!1};case 5:u.label++,a=e[1],e=[0];continue;case 7:e=u.ops.pop(),u.trys.pop();continue;default:if(!(r=0<(r=u.trys).length&&r[r.length-1])&&(6===e[0]||2===e[0])){u=0;continue}if(3===e[0]&&(!r||e[1]>r[0]&&e[1]<r[3])){u.label=e[1];break}if(6===e[0]&&u.label<r[1]){u.label=r[1],r=e;break}if(r&&u.label<r[2]){u.label=r[2],u.ops.push(e);break}r[2]&&u.ops.pop(),u.trys.pop();continue}e=i.call(n,u)}catch(t){e=[6,t],a=0}finally{o=r=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,t])}}}t=function(){return{update:function(t,e,n,i){3==arguments.length&&(i=n,n=void 0);n=this.get(e,n),i=i(n);this.set(e,null!=i?i:n)}}};function a(n){var i=window.history[n];return function(){var t=i.apply(window.history,arguments),e=new Event(n.toLocaleLowerCase());return e.arguments=arguments,window.dispatchEvent(e),t}}function r(t){this.startTime=(new Date).getTime(),this.hiddenStartTime=this.startTime,this.duration=0,this.hiddenDuration=0,this.currURL=window.location.href.split("?")[0],this.defaultConfig={mode:"single",interval:5e3,reportURL:""},this.onPageShow(),this.onPageHide(),this.onPageVisibilityChange(),this.defaultConfig=Object.assign({},this.defaultConfig,t),"single"===this.defaultConfig.mode&&this.initSingle()}return d.default.addPlugin(t),r.prototype.onPageShow=function(){var t=this;window.addEventListener("pageshow",function(){d.default.set("pageshow",(new Date).getTime()),1!==window.performance.navigation.type&&(window.name=e.v4()),t.startTime=(new Date).getTime()})},r.prototype.onPageHide=function(){var n=this;window.addEventListener("pagehide",function(){var t,e;n.duration=(new Date).getTime()-n.startTime,n.duration<n.defaultConfig.interval||(t="single"===n.defaultConfig.mode?n.getAllURLData():((e={})[n.currURL]={duration:n.duration-n.getLocalHiddenDuration()},e),(e=new FormData).append("data",JSON.stringify(function(t){var e,n=[];for(e in t)n.push(i({url:e},t[e]));return n}(t))),navigator.sendBeacon(n.defaultConfig.reportURL,e),d.default.remove("monitor-data-"+window.name))})},r.prototype.onPageVisibilityChange=function(){var t=this;document.addEventListener("visibilitychange",function(){document.hidden?t.hiddenStartTime=(new Date).getTime():(t.hiddenDuration=(new Date).getTime()-t.hiddenStartTime,d.default.set("monitor-duration-hidden-"+window.name,t.hiddenDuration+ +t.getLocalHiddenDuration()))})},r.prototype.getLocalHiddenDuration=function(){return d.default.get("monitor-duration-hidden-"+window.name)||0},r.prototype.initSingle=function(){window.history.pushState=a("pushState"),window.history.replaceState=a("replaceState"),this.onPopState(),this.onPushState(),this.onReplaceState()},r.prototype.onPopState=function(){var t=this;window.addEventListener("popstate",function(){t.setDurationAndURL("popstate")})},r.prototype.onPushState=function(){var t=this;window.addEventListener("pushstate",function(){t.setDurationAndURL("pushstate")})},r.prototype.onReplaceState=function(){var t=this;window.addEventListener("replacestate",function(){t.setDurationAndURL("replacestate")})},r.prototype.setDurationAndURL=function(t){var e=(new Date).getTime()-this.startTime-this.getLocalHiddenDuration();this.startTime=(new Date).getTime(),console.log("触发事件：%c"+t,"background: #606060; color: white; padding: 1px 10px; border-radius: 3px;"),console.log("停留在：%c"+this.currURL,"font-size: 18px;","，页面时长："+e),this.storeData(e),d.default.remove("monitor-duration-hidden-"+window.name),this.hiddenDuration=0,this.currURL=window.location.href.split("?")[0]},r.prototype.storeData=function(u){return o(this,void 0,void 0,function(){var e,n,i,o,a,r;return s(this,function(t){return e=this.currURL,n="monitor-data-"+window.name,i=this.getAllURLData(),(o=i[e])?(a=o.pv,r=o.duration,d.default.update(n,function(t){t[e].pv=a+1,t[e].duration=r+u})):(i[this.currURL]={duration:u,pv:1},d.default.set(n,i)),[2]})})},r.prototype.getAllURLData=function(){return d.default.get("monitor-data-"+window.name)||{}},r});
